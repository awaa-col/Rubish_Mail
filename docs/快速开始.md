[English](en/QuickStart.md)

# 快速开始指南

## 主人,让我手把手教你怎么用这个邮箱监控服务~

---

## 第一步: 安装依赖

打开终端,切换到项目目录:

```bash
cd G:\Class_notes\rubbish_mail
pip install -r requirements.txt
```

---

## 第二步: 配置文件

### 1. 创建 `config.yml`

复制示例配置:
```bash
copy config.example.yml config.yml
```

然后编辑 `config.yml`:

```yaml
# 服务器配置(一般不用改)
server:
  host: "0.0.0.0"
  port: 8000
  reload: false

# 重点! IMAP邮箱服务器配置
imap:
  host: "imap.your-domain.com"      # 改成你的IMAP服务器地址
  port: 993
  use_ssl: true
  allowed_domain: "your-domain.com" # 只允许这个域名的邮箱
  admin_password: "your-password"   # 如果需要密码就填,不需要就删掉

# 监控配置
monitor:
  check_interval: 5        # 每5秒检查一次新邮件
  max_connections: 10      # 最多10个同时监控
  timeout: 300
  mark_as_read: true       # 推送后标记为已读

# 日志
logging:
  level: "INFO"
  file: "logs/rubbish_mail.log"
```

### 2. 创建 `.env` 文件

创建 `.env` 并写入你的API密钥:

```env
API_KEY=随便写一个长长的密钥,比如abc123xyz456
```

> **提示**: API密钥就是暗号,客户端连接时需要提供,只有你知道!

---

## 第三步: 启动服务

```bash
python main.py
```

看到这样的输出就成功了:

```
INFO:     启动邮箱监控服务...
INFO:     IMAP服务器: imap.your-domain.com:993
INFO:     允许的邮箱域名: your-domain.com
INFO:     最大连接数: 10
INFO:     Uvicorn running on http://0.0.0.0:8000
```

---

## 第四步: 测试连接

打开浏览器访问: `http://localhost:8000`

应该看到:
```json
{
  "service": "Rubbish Mail",
  "status": "running",
  "active_connections": 0,
  "timestamp": "..."
}
```

---

## 第五步: 使用客户端

### 方式1: 使用示例客户端

编辑 `example_client.py`,修改这几处:

```python
client = MailMonitorClient(
    ws_url="ws://localhost:8000/ws/monitor",
    api_key="你在.env里设置的API_KEY"  # 改这里!
)

await client.monitor(
    email="test@your-domain.com",  # 改成你要监控的邮箱
    keywords=["验证码", "code"],
    search_in=["subject", "body"]
)
```

然后运行:
```bash
python example_client.py
```

### 方式2: 在你的脚本中使用

```python
import asyncio
import json
import websockets

async def get_verification_code():
    async with websockets.connect("ws://localhost:8000/ws/monitor") as ws:
        # 发送监控请求
        await ws.send(json.dumps({
            "api_key": "你的API密钥",
            "email": "temp@your-domain.com",
            "rules": [{
                "type": "keyword",
                "patterns": ["验证码"],
                "search_in": ["subject", "body"]
            }]
        }))
        
        # 等待邮件
        async for message in ws:
            data = json.loads(message)
            if data["type"] == "email_received":
                email = data["data"]
                print(f"收到邮件: {email['subject']}")
                print(f"正文: {email['body']}")
                # 提取验证码逻辑...
                break

asyncio.run(get_verification_code())
```

---

## 典型使用场景

### 场景1: 自动注册网站

```python
# 1. 脚本触发注册
register_user(email="temp123@your-domain.com")

# 2. 同时启动邮箱监控
async with websockets.connect("ws://localhost:8000/ws/monitor") as ws:
    await ws.send(json.dumps({
        "api_key": "your-key",
        "email": "temp123@your-domain.com",
        "rules": [{
            "type": "regex",
            "patterns": [r"验证码[^\d]*(\d{6})"],  # 匹配6位验证码
            "search_in": ["body"]
        }]
    }))
    
    # 3. 等待验证码邮件
    async for message in ws:
        data = json.loads(message)
        if data["type"] == "email_received":
            code = extract_code(data["data"]["body"])
            # 4. 填入验证码完成注册
            submit_verification(code)
            break
```

### 场景2: 监控特定发件人

```python
# 只监控来自GitHub的邮件
rules = [{
    "type": "regex",
    "patterns": [r"@github\.com$"],
    "search_in": ["sender"]
}]
```

### 场景3: 组合条件

```python
# 同时匹配多个条件(OR关系)
rules = [
    {
        "type": "keyword",
        "patterns": ["验证码", "verification"],
        "search_in": ["subject"]
    },
    {
        "type": "regex",
        "patterns": [r"\d{6}"],
        "search_in": ["body"]
    }
]
```

---

## 常见问题

### Q1: 连接IMAP失败?

**检查清单**:
- [ ] IMAP服务器地址正确?
- [ ] 端口对吗?(SSL通常是993)
- [ ] 邮箱服务器允许IMAP访问?
- [ ] 密码正确?

**调试**: 设置 `logging.level: "DEBUG"` 查看详细日志

### Q2: 收不到邮件推送?

**检查清单**:
- [ ] 邮件在INBOX中?
- [ ] 邮件是未读状态?
- [ ] 规则写对了?
- [ ] 邮箱域名匹配?

**调试**: 查看 `logs/rubbish_mail.log`,看是否有匹配信息

### Q3: WebSocket连接被拒绝?

**可能原因**:
- API_KEY错误
- 邮箱域名不在 `allowed_domain` 中
- 超过最大连接数限制

### Q4: 想监控多个邮箱怎么办?

**方法1**: 创建多个WebSocket连接(每个连接监控一个邮箱)

```python
async def monitor_multiple():
    async with websockets.connect("...") as ws1:
        # 监控邮箱1
        ...
    async with websockets.connect("...") as ws2:
        # 监控邮箱2
        ...
```

**方法2**: 使用 `asyncio.gather` 并发监控

```python
await asyncio.gather(
    monitor_email("email1@domain.com"),
    monitor_email("email2@domain.com")
)
```

---

## 性能调优

### 如果邮件很多,检查很慢?

增加检查间隔:
```yaml
monitor:
  check_interval: 10  # 改成10秒
```

### 如果需要更实时?

减少检查间隔:
```yaml
monitor:
  check_interval: 2  # 改成2秒(注意IMAP服务器压力)
```

### 如果需要更多并发?

增加最大连接数:
```yaml
monitor:
  max_connections: 50  # 根据服务器性能调整
```

---

## 安全提醒

⚠️ **重要**:
1. 不要把 `.env` 和 `config.yml` 提交到Git!
2. API_KEY要足够长和随机
3. 如果暴露到公网,务必使用HTTPS/WSS
4. 定期更换API密钥

---

## 停止服务

在终端按 `Ctrl+C` 即可优雅停止服务

---

好了主人,这样就可以开始用了~有问题随时叫我哦~ (๑´ڡ`๑)

