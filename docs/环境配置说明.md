# 环境配置说明

## 必需文件

项目运行需要以下配置文件:

### 1. config.yml

**创建方法**:
```bash
copy config.example.yml config.yml
```

**必须修改的配置**:

```yaml
imap:
  host: "imap.your-domain.com"      # ← 改成你的IMAP服务器
  allowed_domain: "your-domain.com" # ← 改成你的邮箱域名
  admin_password: "your-password"   # ← 如果需要密码就填
```

**配置项详解**:

#### 服务器配置
```yaml
server:
  host: "0.0.0.0"     # 监听地址,0.0.0.0表示所有网卡
  port: 8000          # 监听端口
  reload: false       # 开发时可设为true,生产环境false
```

#### IMAP配置
```yaml
imap:
  host: "imap.example.com"    # IMAP服务器地址
  port: 993                   # IMAP端口(SSL通常是993)
  use_ssl: true               # 是否使用SSL加密
  
  allowed_domain: "example.com"  # 只允许这个域名的邮箱被监控
  
  # 如果需要IMAP认证(可选)
  admin_user: "admin@example.com"
  admin_password: "password123"
```

**IMAP服务器获取方法**:

- **Gmail**: `imap.gmail.com:993`
  - 需要开启"允许不够安全的应用"或使用应用专用密码

- **Outlook/Hotmail**: `imap-mail.outlook.com:993`

- **QQ邮箱**: `imap.qq.com:993`
  - 需要在设置中开启IMAP并获取授权码

- **163邮箱**: `imap.163.com:993`

- **自建邮箱服务器**: 咨询你的管理员

#### 监控配置
```yaml
monitor:
  check_interval: 5      # 检查新邮件的间隔(秒)
                        # 建议: 2-10秒
                        # 太短会增加服务器负担
                        # 太长会降低实时性
  
  max_connections: 10    # 最大同时监控连接数
                        # 建议: 根据实际需求设置
                        # 自用: 5-10
                        # 多用户: 20-50
  
  timeout: 300          # WebSocket超时时间(秒)
                        # 建议: 300-600
  
  mark_as_read: true    # 推送后是否标记为已读
                        # true: 避免重复推送,推荐
                        # false: 可以多次接收同一邮件
```

#### 日志配置
```yaml
logging:
  level: "INFO"                      # 日志级别
                                    # DEBUG: 详细调试信息
                                    # INFO: 常规信息(推荐)
                                    # WARNING: 警告
                                    # ERROR: 仅错误
  
  file: "logs/rubbish_mail.log"    # 日志文件路径
```

---

### 2. .env 文件

**创建方法**:
在项目根目录创建 `.env` 文件

**内容示例**:
```env
# API密钥(必需)
API_KEY=your-secret-api-key-here

# 可选: 多个API密钥(逗号分隔)
# API_KEYS=key1,key2,key3
```

**生成强API密钥**:

方法1 - Python:
```python
import secrets
print(secrets.token_hex(32))
# 输出: 7f9a2b4e6d8c1a3f5b9e8d7c6a4b2e1f...
```

方法2 - PowerShell:
```powershell
-join ((65..90) + (97..122) + (48..57) | Get-Random -Count 32 | % {[char]$_})
```

方法3 - 在线生成:
- https://randomkeygen.com/
- https://www.uuidgenerator.net/

**安全建议**:
- ✅ 至少32位
- ✅ 包含大小写字母、数字
- ✅ 定期更换
- ❌ 不要使用生日、名字等容易猜到的
- ❌ 不要提交到Git仓库

---

## 目录结构

确保以下目录存在:

```
rubbish_mail/
├── logs/              ← 日志目录(自动创建)
├── core/              ← 核心代码
├── schemas/           ← 数据模型
├── utils/             ← 工具函数
├── 白岚/              ← 项目文档
├── config.yml         ← 配置文件(需要创建)
├── .env               ← 环境变量(需要创建)
└── ...
```

如果 `logs` 目录不存在,运行时会自动创建。

---

## 环境变量优先级

如果同时配置了 `API_KEY` 和 `API_KEYS`:

```env
API_KEY=main-key
API_KEYS=key1,key2,key3
```

则实际生效的密钥为: `[main-key, key1, key2, key3]` (去重后)

**使用场景**:
- `API_KEY`: 主密钥,始终有效
- `API_KEYS`: 额外密钥,可以给不同客户端使用

---

## 常见配置场景

### 场景1: 本地开发

```yaml
# config.yml
server:
  host: "127.0.0.1"  # 只允许本地访问
  port: 8000
  reload: true       # 代码修改自动重载

imap:
  host: "imap.gmail.com"
  allowed_domain: "gmail.com"
  admin_password: "your-app-password"

monitor:
  check_interval: 5
  max_connections: 5
  mark_as_read: false  # 开发时可以重复测试

logging:
  level: "DEBUG"  # 详细日志
```

### 场景2: 生产部署

```yaml
# config.yml
server:
  host: "0.0.0.0"    # 允许外部访问
  port: 8000
  reload: false      # 关闭热重载

imap:
  host: "imap.your-domain.com"
  allowed_domain: "your-domain.com"
  admin_password: "${IMAP_PASSWORD}"  # 从环境变量读取

monitor:
  check_interval: 10  # 降低服务器负载
  max_connections: 50
  mark_as_read: true

logging:
  level: "INFO"  # 只记录重要信息
```

### 场景3: 高实时性需求

```yaml
# config.yml
monitor:
  check_interval: 2   # 2秒检查一次(注意IMAP服务器压力!)
  max_connections: 20
  mark_as_read: true
```

---

## 验证配置

### 1. 检查配置文件语法

```bash
python -c "import yaml; yaml.safe_load(open('config.yml'))"
```

如果没有输出,说明语法正确。

### 2. 测试IMAP连接

```python
import asyncio
import aioimaplib

async def test_imap():
    client = aioimaplib.IMAP4_SSL(host="imap.example.com", port=993)
    await client.wait_hello_from_server()
    result = await client.login("user@example.com", "password")
    print(result)
    await client.logout()

asyncio.run(test_imap())
```

### 3. 启动服务检查

```bash
python main.py
```

看到以下输出说明配置正确:
```
INFO:     启动邮箱监控服务...
INFO:     IMAP服务器: imap.example.com:993
INFO:     允许的邮箱域名: example.com
INFO:     最大连接数: 10
INFO:     Uvicorn running on http://0.0.0.0:8000
```

---

## 故障排查

### 问题1: "配置文件不存在"

**错误**:
```
FileNotFoundError: 配置文件不存在: config.yml
请复制 config.example.yml 为 config.yml 并填写配置
```

**解决**:
```bash
copy config.example.yml config.yml
# 然后编辑 config.yml
```

---

### 问题2: "未找到API_KEY环境变量"

**错误**:
```
ValueError: 未找到API_KEY环境变量
请创建.env文件并设置: API_KEY=your-secret-key
```

**解决**:
创建 `.env` 文件:
```env
API_KEY=your-key-here
```

---

### 问题3: "IMAP登录失败"

**错误**:
```
ConnectionError: IMAP登录失败: ...
```

**检查清单**:
- [ ] IMAP服务器地址正确?
- [ ] 端口正确?(SSL=993, 非SSL=143)
- [ ] 邮箱用户名正确?
- [ ] 密码正确?(某些邮箱需要应用专用密码)
- [ ] 邮箱服务器是否启用了IMAP?

**Gmail特殊说明**:
1. 开启两步验证
2. 生成应用专用密码: https://myaccount.google.com/apppasswords
3. 使用应用密码代替账户密码

---

### 问题4: "YAML解析错误"

**错误**:
```
yaml.YAMLError: ...
```

**常见原因**:
- 缩进不正确(YAML使用空格,不能用Tab)
- 冒号后面没有空格
- 引号不匹配

**正确格式**:
```yaml
imap:
  host: "imap.example.com"  # ← 冒号后有空格
  port: 993                 # ← 缩进2个空格
```

---

## 配置备份

**重要**: 配置文件包含敏感信息,请妥善保管!

**备份方法**:
```bash
# 备份配置
copy config.yml config.yml.backup
copy .env .env.backup

# 加密备份(推荐)
7z a -p config_backup.7z config.yml .env
```

**不要**:
- ❌ 提交到公开Git仓库
- ❌ 发送到聊天软件
- ❌ 截图分享

---

主人,配置说明写完了!按照这个一步步来肯定不会出错的~
如果还是有问题,那一定是主人没仔细看文档!哼!(╯‵□′)╯︵┻━┻

